---
title: "EH245 Final Assignment"
author: "Armelle Duston, Rebecca Hurwitz"
date: "`r Sys.Date()`"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


# Libraries and Load Data

```{r}

library(dplyr)
library(ggplot2)
library(corrplot)
library(gWQS)

load("exposome.Rdata")

```

# Data processing

```{r}

metal_names_df <- codebook |>
  filter(family == "Metals") |>
  select(variable_name) |>
  mutate(variable_name = as.character(variable_name))

metal_names <- metal_names_df$variable_name


# Exposure dataframe for metals only
metals_df <- exposome[,c("ID", metal_names)] |>
  mutate(hs_tl_cdich_None = ifelse(hs_tl_cdich_None == "Detected", 1, 0)) |>
  mutate(hs_tl_mdich_None = ifelse(hs_tl_mdich_None == "Detected", 1, 0)) 

colnames(metals_df) <- c("ID", paste0("x", as.character(1:20)))
head(metals_df)

# Full dataframe including covariates + outcomes
full_data <- metals_df |>
  left_join(covariates, by = "ID") |>
  left_join(phenotype, by = "ID")
  
head(full_data)
  
head(exposome)
```

# Correlation Analysis
Armelle
```{r}

corrplot(cor(metals_df[2:21]))

```

Comments: 
- Correlation between elements of our mixture seem quite low, I am not very concerned about multi-collinearity or other complexity due to correlated data
- Wow yeah super low!! Kinda surprising

# Regression Analysis
Becca
```{r}
# standardizing
full_data[paste0("x", 1:20)] <- scale(full_data[paste0("x", 1:20)])

# putting some of your code up here! 
mix_name = paste0("x", as.character(1:20)) # x1, ..., x20

# get covariate names
cov_names_df <- codebook |>
  filter(family == "Covariates") |>
  select(variable_name) |>
  mutate(variable_name = as.character(variable_name))
cov_names <- cov_names_df$variable_name

# From Brent's slides: Adjusted for covariates: Cohort, gestational age at birth, maternal BMI, maternal weight gain, maternal education, parity, native to country of birth
cov_brent <- c(
  "h_cohort",
  "e3_gac_None",
  "h_mbmi_None",
  "hs_wgtgain_None",
  "h_edumc_None",
  "h_parity_None",
  "h_native_None"
)

# linear regression
lm_formula <- as.formula(
  paste(
    "hs_zbmi_who ~",
    paste(c(mix_name, cov_brent), collapse = " + ")
  )
)
lmall <- lm(lm_formula, data = full_data)
summary(lmall)
vif(lmall)

```

# WQS 
Armelle
```{r}


mix_name = paste0("x", as.character(1:20)) # x1, ..., x20

# get covariate names
cov_names_df <- codebook |>
  filter(family == "Covariates") |>
  select(variable_name) |>
  mutate(variable_name = as.character(variable_name))
cov_names <- cov_names_df$variable_name

formula = as.formula(paste0(
  "hs_zbmi_who ~ pwqs + nwqs + ",
  paste(cov_names, collapse = " + ")
))

gwqs_res <- gwqs(formula,
                 mix_name = mix_name, 
                 data = full_data,
                 q = 4, # quartiles
                 validation = 0.6, 
                 b = 500, 
                 family = "gaussian", 
                 seed = 245)

```


# BKMR (or BMIM?)
Becca
```{r}

```

# Stuff we probs won't use
```{r}
# adding installation of the rexposome package they mentioned in class in case it is helpful for us

if (!requireNamespace("BiocManager", quietly=TRUE))
    install.packages("BiocManager")

packages = c('Biobase', 'mice', 'MultiDataSet', 'lsr', 'FactoMineR',
	'stringr', 'circlize', 'corrplot', 'ggplot2', 'reshape2', 'pryr',
	'scales', 'imputeLCMD', 'scatterplot3d', 'glmnet', 'gridExtra',
	'grid', 'Hmisc', 'gplots', 'gtools', 'S4Vectors'
)
for( pkg in packages ) {
  if( !pkg %in% rownames( installed.packages() ) ) {
    message( "Installing ", pkg )
    BiocManager::install( pkg )
  }
}

devtools::install_github("isglobal-brge/rexposome", ref="R-3.0")
# requires special files but we have them!

library(rexposome)
summary(exposome)
glimpse(exposome)

install.packages("visdat")
library(visdat)

tableLOD
```

